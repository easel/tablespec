name: Release & Publish

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Build package
        run: uv build

      - name: Verify build
        run: |
          ls -lh dist/
          echo "Built packages:"
          ls -1 dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 90

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Extract release notes
        id: release_notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Create release notes
          cat > release_notes.md << EOF
          ## tablespec $TAG

          ### Installation

          \`\`\`bash
          # From GitHub Pages index
          pip install tablespec==${TAG#v} --index-url https://easel.github.io/tablespec/simple/

          # With PySpark support
          pip install tablespec[spark]==${TAG#v} --index-url https://easel.github.io/tablespec/simple/
          \`\`\`

          ### What's Changed

          See the [commit history](https://github.com/easel/tablespec/commits/$TAG) for details.

          ### Artifacts

          - Source distribution (sdist): \`tablespec-${TAG#v}.tar.gz\`
          - Wheel distribution: \`tablespec-${TAG#v}-py3-none-any.whl\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.release_notes.outputs.tag, 'rc') || contains(steps.release_notes.outputs.tag, 'alpha') || contains(steps.release_notes.outputs.tag, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-index:
    name: Build PyPI Index for GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Generate PyPI-compatible index
        run: |
          mkdir -p pages/simple/tablespec

          # Create root index.html
          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>tablespec - Private PyPI Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
              h1 { color: #0366d6; }
              code { background: #f6f8fa; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; }
              .container { max-width: 800px; margin: 0 auto; }
              .badge { display: inline-block; padding: 4px 8px; background: #0366d6; color: white; border-radius: 3px; font-size: 12px; margin: 4px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ“Š tablespec</h1>
              <p><span class="badge">Python 3.12+</span> <span class="badge">Apache 2.0</span></p>
              <p>Python library for working with table schemas in Universal Metadata Format (UMF)</p>

              <h2>Installation</h2>
              <pre>pip install tablespec --index-url https://easel.github.io/tablespec/simple/</pre>

              <h2>Quick Start</h2>
              <pre>
          # Load and validate UMF schema
          from tablespec import load_umf_from_yaml, generate_sql_ddl

          umf = load_umf_from_yaml("schema.yaml")
          ddl = generate_sql_ddl(umf)
          print(ddl)

          # With PySpark support
          pip install tablespec[spark] --index-url https://easel.github.io/tablespec/simple/
              </pre>

              <h2>Available Packages</h2>
              <ul>
                <li><a href="simple/tablespec/">tablespec</a></li>
              </ul>

              <h2>Links</h2>
              <ul>
                <li><a href="https://github.com/easel/tablespec">GitHub Repository</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF

          # Create simple/index.html (PEP 503)
          cat > pages/simple/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Simple Index</title></head>
          <body>
            <h1>Simple Index</h1>
            <a href="tablespec/">tablespec</a><br/>
          </body>
          </html>
          EOF

          # Create package index with all versions
          cat > pages/simple/tablespec/index.html << 'PKGEOF'
          <!DOCTYPE html>
          <html>
          <head><title>Links for tablespec</title></head>
          <body>
            <h1>Links for tablespec</h1>
          PKGEOF

          # Add links to all distribution files
          for file in dist/*; do
            filename=$(basename "$file")
            # Calculate SHA256 hash
            hash=$(sha256sum "$file" | cut -d' ' -f1)
            echo "    <a href=\"../../../releases/download/${GITHUB_REF#refs/tags/}/$filename#sha256=$hash\">$filename</a><br/>" >> pages/simple/tablespec/index.html
          done

          # Close HTML
          cat >> pages/simple/tablespec/index.html << 'PKGEOF'
          </body>
          </html>
          PKGEOF

          # Create .nojekyll to disable Jekyll processing
          touch pages/.nojekyll

          echo "Generated index structure:"
          find pages -type f -exec echo "  {}" \;

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-index
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  verify:
    name: Verify Release
    needs: [release, deploy-pages]
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Wait for GitHub Pages propagation
        run: sleep 60

      - name: Verify GitHub Pages installation
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}

          # Try installing from GitHub Pages index
          pip install --index-url https://easel.github.io/tablespec/simple/ tablespec==$VERSION || echo "GitHub Pages index not yet available"

      - name: Summary
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          cat << EOF
          âœ… Release $TAG complete!

          ðŸ“„ GitHub Pages: https://easel.github.io/tablespec/
          ðŸ·ï¸  GitHub Release: https://github.com/easel/tablespec/releases/tag/$TAG
          EOF
